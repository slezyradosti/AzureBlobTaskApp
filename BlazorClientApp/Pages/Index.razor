@page "/"
@using BlazorClientApp.Data
@using BlazorClientApp.Services

<div class="container-sm">
    <EditForm Model="@blob" OnSubmit=@blob.HandleValidRequestAsync>
        <div class="form-group">
            <label class="col-md-3">Email</label>
            <InputText class="col-md-8 form-control" @bind-Value="@blob.blobFormDto.Email" oninput="@ClearMessages"></InputText>
            <label class="col-md-3">FIle document</label>
            <InputFile OnChange="@LoadFiles" class="col-md-8 form-control" accept=".docx"></InputFile>
            <DataAnnotationsValidator />
            <ValidationSummary />
            <p style="color: red">@blob.ErrorMessage</p>
        </div>
        <br/>
        <div class="form-group">
            <button type="submit" class="btn btn-success" disabled="@(!context.IsModified())">Submit</button>
        </div>
        <br/>
        <p style="color: limegreen">@blob.SuccessMessage</p>
    </EditForm>
</div>

@code {
    private Blobs blob;

    protected override void OnInitialized() => blob ??= new();

    private void ClearMessages()
    {
        blob.ErrorMessage = string.Empty;
        blob.SuccessMessage = string.Empty;
    }

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        ClearMessages();

        byte[] fileBytes;
        using (var ms = new MemoryStream())
        {
            await e.File.OpenReadStream().CopyToAsync(ms);
            fileBytes = ms.ToArray();
        }

        var fileName = e.File.Name;
        var contentType = e.File.ContentType;

        var formFile = new FormFile(new MemoryStream(fileBytes), 0, fileBytes.Length, null, fileName)
            {
                Headers = new HeaderDictionary(),
                ContentType = contentType,
                ContentDisposition = $"form-data; name=\"file\"; filename=\"{fileName}\""
            };

        blob.blobFormDto.File = formFile;
    }
}